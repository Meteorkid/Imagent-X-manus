# ImagentX 部署到域名指南

## 🎯 概述

本指南将帮助您将ImagentX项目部署到域名 `imagentx.top`，包括完整的生产环境配置、SSL证书管理和自动化部署。

## 📋 前置要求

### 服务器要求
- **操作系统**: Ubuntu 20.04+ / CentOS 8+ / macOS
- **内存**: 最少 4GB RAM（推荐 8GB+）
- **存储**: 最少 20GB 可用空间
- **网络**: 公网IP，80和443端口开放

### 软件要求
- **Docker**: 20.10+
- **Docker Compose**: 2.0+
- **Git**: 最新版本

### 域名配置
- 域名 `imagentx.top` 已购买
- DNS解析已配置到服务器IP
- 支持A记录和CNAME记录

## 🚀 快速部署

### 1. 准备环境

```bash
# 克隆项目
git clone <your-repo-url>
cd ImagentX-master

# 安装Docker（如果未安装）
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### 2. 配置环境变量

```bash
# 复制环境变量模板
cp env.production.template .env.production

# 编辑配置文件
nano .env.production
```

**重要配置项：**
```bash
# 数据库配置
DB_USER=imagentx_user
DB_PASSWORD=your_secure_password_here  # 更改此密码
DB_NAME=imagentx

# JWT密钥（必须更改）
JWT_SECRET=your_very_secure_jwt_secret_key_here_change_this_in_production

# 管理员账户
IMAGENTX_ADMIN_EMAIL=admin@imagentx.top
IMAGENTX_ADMIN_PASSWORD=your_admin_password_here  # 更改此密码

# SSL证书邮箱
SSL_EMAIL=admin@imagentx.top
```

### 3. 初始化部署

```bash
# 给部署脚本执行权限
chmod +x deploy-production.sh

# 初始化部署
./deploy-production.sh --init
```

### 4. 部署服务

```bash
# 部署所有服务
./deploy-production.sh --deploy
```

### 5. 验证部署

```bash
# 检查服务状态
./deploy-production.sh --status

# 访问网站
# 前端: https://imagentx.top
# 后端API: https://imagentx.top/api
# 健康检查: https://imagentx.top/health
```

## 🔧 详细配置

### 域名DNS配置

在您的域名管理面板中配置以下DNS记录：

```
类型    名称    值
A       @       您的服务器IP
A       www     您的服务器IP
CNAME   api     您的服务器IP
```

### SSL证书配置

项目使用Let's Encrypt自动获取SSL证书：

1. **自动获取**: 首次部署时会自动获取证书
2. **自动续期**: 证书会在到期前自动续期
3. **手动更新**: 如需手动更新，运行：
   ```bash
   ./deploy-production.sh --ssl
   ```

### 数据库配置

PostgreSQL数据库配置：
- **端口**: 5432（内部）
- **数据库名**: imagentx
- **用户名**: imagentx_user
- **密码**: 在.env.production中配置

### 消息队列配置

RabbitMQ配置：
- **管理界面**: https://imagentx.top:15672
- **用户名**: imagentx_user
- **密码**: 在.env.production中配置

## 📊 监控和维护

### 查看日志

```bash
# 查看所有服务日志
./deploy-production.sh --logs

# 查看特定服务日志
docker-compose -f docker-compose-production.yml logs -f imagentx-backend-prod
```

### 备份数据

```bash
# 创建完整备份
./deploy-production.sh --backup
```

### 更新服务

```bash
# 更新到最新版本
./deploy-production.sh --update
```

### 重启服务

```bash
# 重启所有服务
./deploy-production.sh --restart

# 重启特定服务
docker-compose -f docker-compose-production.yml restart imagentx-backend-prod
```

## 🔒 安全配置

### 防火墙配置

```bash
# 只开放必要端口
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable
```

### 安全最佳实践

1. **更改默认密码**: 确保更改所有默认密码
2. **定期更新**: 定期更新系统和Docker镜像
3. **监控日志**: 定期检查访问日志
4. **备份策略**: 设置自动备份计划
5. **SSL配置**: 使用强加密套件

## 🚨 故障排除

### 常见问题

1. **SSL证书获取失败**
   ```bash
   # 检查域名解析
   nslookup imagentx.top
   
   # 检查80端口是否开放
   sudo netstat -tlnp | grep :80
   ```

2. **服务启动失败**
   ```bash
   # 查看详细日志
   docker-compose -f docker-compose-production.yml logs
   
   # 检查端口占用
   sudo netstat -tlnp | grep -E ":(80|443|3000|8088)"
   ```

3. **数据库连接失败**
   ```bash
   # 检查数据库状态
   docker exec imagentx-postgres-prod psql -U imagentx_user -d imagentx -c "SELECT version();"
   ```

### 性能优化

1. **启用Gzip压缩**: 已在Nginx配置中启用
2. **静态资源缓存**: 已配置长期缓存
3. **数据库优化**: 根据访问量调整连接池
4. **CDN配置**: 可配置CDN加速静态资源

## 📞 技术支持

如果遇到问题：

1. 检查日志文件
2. 验证网络连接
3. 确认DNS配置
4. 检查防火墙设置
5. 查看Docker容器状态

### 有用的命令

```bash
# 查看所有容器状态
docker ps -a

# 查看系统资源使用
docker stats

# 清理未使用的资源
docker system prune -a

# 查看磁盘使用
df -h

# 查看内存使用
free -h
```

## 🎉 部署完成

部署完成后，您可以通过以下地址访问：

- **主站**: https://imagentx.top
- **API文档**: https://imagentx.top/api
- **管理界面**: https://imagentx.top/admin
- **健康检查**: https://imagentx.top/health

恭喜！您的ImagentX项目已成功部署到生产环境。
