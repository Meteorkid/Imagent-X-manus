# 🚀 部署执行详细指南

## 📋 部署前确认清单

### ✅ 已完成准备
- [x] 服务器已购买并配置
- [x] 域名DNS解析已配置
- [x] 所有部署文件已准备就绪
- [x] Mac环境工具已安装

### 📝 需要记录的信息
```
服务器IP: _________________
SSH密码: _________________
域名: imagentx.top
DNS服务商: 阿里云
```

## 🚀 部署执行步骤

### 步骤1: 连接服务器 (5分钟)

#### 1.1 在Mac终端中连接服务器
```bash
# 打开Mac终端
ssh root@[您的服务器IP]

# 示例
ssh root@123.456.789.123
```

**首次连接提示**:
```
The authenticity of host '123.456.789.123' can't be established.
ECDSA key fingerprint is SHA256:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.
Are you sure you want to continue connecting (yes/no/[fingerprint])?
```
**输入**: `yes`

#### 1.2 更新服务器系统
```bash
# 在服务器上执行
apt update && apt upgrade -y
```

**预期输出**:
```
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following packages will be upgraded:
  [包列表]
Do you want to continue? [Y/n]
```
**输入**: `Y`

### 步骤2: 上传项目代码 (10分钟)

#### 2.1 在Mac上准备部署包
```bash
# 在Mac终端中执行（新开一个终端窗口）
cd /Users/Meteorkid/Downloads/ImagentX-master

# 创建部署包
tar -czf imagentx-deploy.tar.gz \
  --exclude='.git' \
  --exclude='node_modules' \
  --exclude='target' \
  --exclude='logs' \
  --exclude='temp' \
  --exclude='*.tar.gz' \
  .
```

**预期输出**:
```
tar: Removing leading `/' from member names
```

#### 2.2 上传到服务器
```bash
# 在Mac终端中执行
scp imagentx-deploy.tar.gz root@[您的服务器IP]:/opt/

# 示例
scp imagentx-deploy.tar.gz root@123.456.789.123:/opt/
```

**预期输出**:
```
imagentx-deploy.tar.gz    100%   50MB   5.0MB/s   00:10
```

#### 2.3 在服务器上解压
```bash
# 在服务器上执行
mkdir -p /opt/imagentx
cd /opt/imagentx
tar -xzf /opt/imagentx-deploy.tar.gz
```

**预期输出**:
```
[解压文件列表]
```

### 步骤3: 配置环境变量 (5分钟)

#### 3.1 复制环境变量模板
```bash
# 在服务器上执行
cp env.production.template .env.production
```

#### 3.2 编辑环境变量
```bash
# 在服务器上执行
nano .env.production
```

#### 3.3 重要配置项（请修改以下值）
```bash
# 数据库配置
DB_USER=imagentx_user
DB_PASSWORD=YourSecurePassword123!  # 修改为强密码
DB_NAME=imagentx

# JWT密钥（必须更改）
JWT_SECRET=YourVerySecureJWTSecretKeyHereChangeThisInProduction  # 修改为强密钥

# 管理员账户
IMAGENTX_ADMIN_EMAIL=admin@imagentx.top
IMAGENTX_ADMIN_PASSWORD=AdminSecurePassword123!  # 修改为强密码

# SSL证书邮箱
SSL_EMAIL=admin@imagentx.top

# 向量存储配置（可选）
EMBEDDING_ENABLED=false

# 域名配置
DOMAIN=imagentx.top
```

**保存文件**: 按 `Ctrl+X`，然后按 `Y`，最后按 `Enter`

### 步骤4: 设置服务器环境 (15分钟)

#### 4.1 给脚本执行权限
```bash
# 在服务器上执行
chmod +x *.sh
```

#### 4.2 执行环境设置
```bash
# 在服务器上执行
./quick-deploy.sh --setup
```

**预期输出**:
```
🔧 设置服务器环境
--------------------------------
更新系统...
安装必要工具...
安装Docker...
安装Docker Compose...
配置防火墙...
✅ 服务器环境设置完成
```

**如果遇到错误**:
- Docker安装失败: 检查网络连接
- 权限问题: 确保以root用户执行
- 防火墙配置失败: 手动执行 `ufw allow 22/tcp && ufw allow 80/tcp && ufw allow 443/tcp && ufw enable`

### 步骤5: 部署项目 (20分钟)

#### 5.1 执行完整部署
```bash
# 在服务器上执行
./quick-deploy.sh --deploy
```

**预期输出**:
```
🚀 部署项目
--------------------------------
📋 环境检查
✅ 环境检查通过
🚀 部署服务
构建并启动服务...
等待服务启动...
📊 服务状态检查
✅ 部署完成
```

#### 5.2 检查部署状态
```bash
# 在服务器上执行
./quick-deploy.sh --status
```

**预期输出**:
```
📊 检查状态
--------------------------------
✅ PostgreSQL: 运行中
✅ RabbitMQ: 运行中
✅ 后端服务: 运行中
✅ 前端服务: 运行中
✅ Nginx: 运行中
✅ Certbot: 运行中
```

### 步骤6: 验证部署 (15分钟)

#### 6.1 在Mac上测试DNS解析
```bash
# 在Mac终端中执行（新开一个终端窗口）
cd /Users/Meteorkid/Downloads/ImagentX-master
./check-dns.sh --check
```

**预期输出**:
```
🌐 DNS配置完整检查
==================================
🔧 检查DNS服务器配置...
🔍 使用nslookup检查DNS解析...
检查主域名: imagentx.top
Server:         8.8.8.8
Address:        8.8.8.8#53

Non-authoritative answer:
Name:   imagentx.top
Address: [您的服务器IP]

✅ DNS配置检查完成
```

#### 6.2 测试网站访问
```bash
# 在Mac终端中执行
curl -I https://imagentx.top
```

**预期输出**:
```
HTTP/2 200
server: nginx/1.18.0
content-type: text/html; charset=utf-8
```

#### 6.3 测试API接口
```bash
# 在Mac终端中执行
curl https://imagentx.top/api/health
```

**预期输出**:
```json
{"status":"UP","timestamp":"2024-01-01T12:00:00.000Z"}
```

#### 6.4 浏览器访问测试
1. 打开浏览器
2. 访问: https://imagentx.top
3. 应该看到ImagentX登录页面

## 🔍 详细验证检查

### 使用部署检查清单
```bash
# 在Mac终端中执行
cat 部署检查清单.md
```

**逐项检查**:
- [ ] 服务器环境设置完成
- [ ] 项目代码上传成功
- [ ] 环境变量配置完成
- [ ] 部署脚本执行成功
- [ ] 所有服务启动正常
- [ ] DNS解析生效
- [ ] 网站可正常访问
- [ ] SSL证书获取成功
- [ ] 管理员登录功能正常
- [ ] API接口响应正常

### 服务健康检查
```bash
# 在服务器上执行
docker-compose -f docker-compose-production.yml ps
```

**预期输出**:
```
Name                    Command               State           Ports
imagentx-backend-prod   java -jar target/im ...   Up      0.0.0.0:8088->8088/tcp
imagentx-frontend-prod  node server.js            Up      0.0.0.0:3000->3000/tcp
imagentx-nginx-prod     /docker-entrypoint.sh     Up      0.0.0.0:443->443/tcp
imagentx-postgres-prod  docker-entrypoint.sh      Up      0.0.0.0:5432->5432/tcp
imagentx-rabbitmq-prod  docker-entrypoint.sh      Up      0.0.0.0:5672->5672/tcp
```

### SSL证书验证
```bash
# 在服务器上执行
docker logs imagentx-certbot
```

**预期输出**:
```
Saving debug log to /var/log/letsencrypt/letsencrypt.log
Plugins selected: Authenticator webroot, Installer None
Obtaining a new certificate
Performing the following challenges:
http-01 challenge for imagentx.top
Waiting for verification...
Cleaning up challenges
IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/imagentx.top/fullchain.pem
```

## 🚨 常见问题解决

### 1. 部署失败
```bash
# 查看详细日志
./quick-deploy.sh --logs

# 重启服务
./quick-deploy.sh --restart
```

### 2. DNS解析失败
```bash
# 检查DNS配置
nslookup imagentx.top

# 等待DNS生效（最多30分钟）
```

### 3. SSL证书获取失败
```bash
# 检查Certbot日志
docker logs imagentx-certbot

# 手动获取证书
docker exec imagentx-certbot certbot certonly --webroot -w /var/www/certbot -d imagentx.top
```

### 4. 服务启动失败
```bash
# 查看容器状态
docker ps -a

# 查看容器日志
docker logs [容器名称]

# 重启特定服务
docker-compose -f docker-compose-production.yml restart [服务名]
```

## 🎉 部署成功确认

### 最终验证
1. **网站访问**: https://imagentx.top ✅
2. **SSL证书**: 浏览器显示安全锁 ✅
3. **管理员登录**: https://imagentx.top/login ✅
4. **API接口**: https://imagentx.top/api/health ✅

### 管理员账户信息
- **邮箱**: admin@imagentx.top
- **密码**: 您在.env.production中设置的密码

### 访问地址
- **主站**: https://imagentx.top
- **管理后台**: https://imagentx.top/login
- **API文档**: https://imagentx.top/api
- **健康检查**: https://imagentx.top/health

## 📞 后续维护

### 常用命令
```bash
# 查看服务状态
ssh root@[您的服务器IP] "cd /opt/imagentx && ./quick-deploy.sh --status"

# 查看日志
ssh root@[您的服务器IP] "cd /opt/imagentx && ./quick-deploy.sh --logs"

# 重启服务
ssh root@[您的服务器IP] "cd /opt/imagentx && ./quick-deploy.sh --restart"

# 更新部署
ssh root@[您的服务器IP] "cd /opt/imagentx && ./quick-deploy.sh --update"
```

**恭喜！您的ImagentX项目已成功部署到生产环境！** 🚀

现在您可以通过 https://imagentx.top 访问您的网站了！
