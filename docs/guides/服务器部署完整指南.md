# 🚀 ImagentX 服务器部署完整指南

## 📋 部署前准备清单

### 1. 服务器要求
- **操作系统**: Ubuntu 20.04+ / CentOS 8+ / Debian 11+
- **内存**: 最少 4GB RAM（推荐 8GB+）
- **存储**: 最少 20GB 可用空间
- **网络**: 公网IP，80和443端口开放
- **带宽**: 推荐 5Mbps+

### 2. 域名要求
- **域名**: imagentx.top（已购买）
- **DNS管理**: 可以修改DNS记录
- **解析时间**: 通常需要5-30分钟生效

### 3. 软件要求
- **Docker**: 20.10+
- **Docker Compose**: 2.0+
- **Git**: 最新版本

## 🔧 服务器环境准备

### 步骤1: 连接服务器
```bash
# SSH连接到您的服务器
ssh root@your-server-ip

# 更新系统
apt update && apt upgrade -y
```

### 步骤2: 安装Docker
```bash
# 安装Docker
curl -fsSL https://get.docker.com | sh

# 启动Docker服务
systemctl start docker
systemctl enable docker

# 验证安装
docker --version
```

### 步骤3: 安装Docker Compose
```bash
# 安装Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# 验证安装
docker-compose --version
```

### 步骤4: 配置防火墙
```bash
# 开放必要端口
ufw allow 22/tcp    # SSH
ufw allow 80/tcp    # HTTP
ufw allow 443/tcp   # HTTPS
ufw enable

# 验证端口开放
ufw status
```

## 🌐 DNS配置

### 步骤1: 登录域名管理面板
访问您的域名注册商管理面板（如阿里云、腾讯云等）

### 步骤2: 添加DNS记录
```
类型    名称    值              说明
A       @       your-server-ip  主域名解析
A       www     your-server-ip  www子域名解析
```

### 步骤3: 验证DNS解析
```bash
# 在本地验证DNS解析
nslookup imagentx.top
nslookup www.imagentx.top
```

## 📦 代码部署

### 步骤1: 克隆项目
```bash
# 在服务器上创建项目目录
mkdir -p /opt/imagentx
cd /opt/imagentx

# 克隆项目（替换为您的仓库地址）
git clone https://github.com/your-username/ImagentX.git .
# 或者上传项目文件到服务器
```

### 步骤2: 配置环境变量
```bash
# 复制环境变量模板
cp env.production.template .env.production

# 编辑环境变量文件
nano .env.production
```

**重要配置项：**
```bash
# 数据库配置
DB_USER=imagentx_user
DB_PASSWORD=your_secure_password_here
DB_NAME=imagentx

# JWT密钥（必须更改）
JWT_SECRET=your_very_secure_jwt_secret_key_here

# 管理员账户
IMAGENTX_ADMIN_EMAIL=admin@imagentx.top
IMAGENTX_ADMIN_PASSWORD=your_admin_password_here

# SSL证书邮箱
SSL_EMAIL=admin@imagentx.top

# 域名配置
DOMAIN=imagentx.top
```

### 步骤3: 给部署脚本执行权限
```bash
chmod +x deploy-production.sh
```

## 🚀 执行部署

### 步骤1: 初始化部署
```bash
# 执行初始化部署
./deploy-production.sh --init
```

**预期输出：**
```
📋 环境检查
--------------------------------
✅ 环境检查通过
🚀 初始化部署
--------------------------------
启动基础服务...
等待服务启动...
初始化数据库...
✅ 初始化完成
```

### 步骤2: 完整部署
```bash
# 执行完整部署
./deploy-production.sh --deploy
```

**预期输出：**
```
📋 环境检查
--------------------------------
✅ 环境检查通过
🚀 部署服务
--------------------------------
构建并启动服务...
等待服务启动...
📊 服务状态检查
--------------------------------
✅ 部署完成
```

### 步骤3: 验证部署
```bash
# 检查服务状态
./deploy-production.sh --status

# 测试网站访问
curl -I https://imagentx.top
curl -I https://imagentx.top/api/health
```

## 🔒 SSL证书配置

### 自动SSL证书（推荐）
项目已配置Let's Encrypt自动SSL证书：
- 首次访问时自动获取证书
- 证书自动续期
- 无需手动配置

### 手动SSL证书（可选）
如果需要使用自己的SSL证书：

1. **上传证书文件**
```bash
mkdir -p config/ssl
# 上传证书文件到 config/ssl/ 目录
```

2. **修改Nginx配置**
```bash
# 编辑Nginx配置
nano config/nginx/nginx-production.conf
```

3. **重启服务**
```bash
docker-compose -f docker-compose-production.yml restart nginx
```

## 📊 部署验证

### 功能测试
```bash
# 测试前端访问
curl -I https://imagentx.top

# 测试后端API
curl https://imagentx.top/api/health

# 测试健康检查
curl https://imagentx.top/health
```

### 服务状态检查
```bash
# 查看所有容器状态
docker-compose -f docker-compose-production.yml ps

# 查看服务日志
docker-compose -f docker-compose-production.yml logs -f
```

## 🔧 常用管理命令

### 服务管理
```bash
# 查看服务状态
./deploy-production.sh --status

# 重启服务
./deploy-production.sh --restart

# 停止服务
./deploy-production.sh --stop

# 查看日志
./deploy-production.sh --logs
```

### 更新部署
```bash
# 拉取最新代码
git pull origin main

# 重新部署
./deploy-production.sh --update
```

### 备份数据
```bash
# 创建备份
./deploy-production.sh --backup
```

## 🚨 故障排除

### 常见问题

1. **SSL证书获取失败**
   ```bash
   # 检查域名解析
   nslookup imagentx.top
   
   # 检查80端口是否开放
   netstat -tlnp | grep :80
   
   # 查看certbot日志
   docker logs imagentx-certbot
   ```

2. **服务启动失败**
   ```bash
   # 查看详细日志
   docker-compose -f docker-compose-production.yml logs
   
   # 检查端口占用
   netstat -tlnp | grep -E ":(80|443|3000|8088)"
   ```

3. **数据库连接失败**
   ```bash
   # 检查数据库状态
   docker exec imagentx-postgres-prod psql -U imagentx_user -d imagentx -c "SELECT version();"
   ```

4. **前端无法访问**
   ```bash
   # 检查前端容器状态
   docker logs imagentx-frontend-prod
   
   # 检查网络配置
   docker network ls
   ```

### 性能优化

1. **启用Gzip压缩**（已配置）
2. **静态资源缓存**（已配置）
3. **数据库优化**
   ```bash
   # 根据访问量调整连接池
   # 在.env.production中配置
   ```

4. **CDN配置**（可选）
   - 配置CDN加速静态资源
   - 配置CDN加速图片和文件

## 📈 监控和维护

### 系统监控
```bash
# 查看系统资源使用
docker stats

# 查看磁盘使用
df -h

# 查看内存使用
free -h
```

### 日志管理
```bash
# 查看应用日志
docker-compose -f docker-compose-production.yml logs -f

# 查看Nginx访问日志
docker exec imagentx-nginx-prod tail -f /var/log/nginx/access.log

# 查看错误日志
docker exec imagentx-nginx-prod tail -f /var/log/nginx/error.log
```

### 定期维护
```bash
# 清理未使用的Docker资源
docker system prune -a

# 更新Docker镜像
docker-compose -f docker-compose-production.yml pull

# 重启服务
./deploy-production.sh --restart
```

## 🎯 部署完成检查清单

- [ ] 服务器环境准备完成
- [ ] DNS解析配置正确
- [ ] 项目代码上传到服务器
- [ ] 环境变量配置完成
- [ ] 初始化部署成功
- [ ] 完整部署成功
- [ ] SSL证书获取成功
- [ ] 前端访问正常
- [ ] 后端API正常
- [ ] 健康检查通过
- [ ] 管理员账户可登录

## 🎉 部署完成

恭喜！您的ImagentX项目已成功部署到生产环境。

### 访问地址
- **主站**: https://imagentx.top
- **后端API**: https://imagentx.top/api
- **健康检查**: https://imagentx.top/health
- **管理员登录**: https://imagentx.top/login

### 管理员账户
- **邮箱**: admin@imagentx.top
- **密码**: 您在.env.production中设置的密码

### 技术支持
如果遇到问题，请查看：
1. 服务日志
2. 容器状态
3. 网络配置
4. DNS解析

**您的ImagentX项目现在已经在生产环境中运行！** 🚀
